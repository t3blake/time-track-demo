<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Entry Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }
    header { background: linear-gradient(135deg, #0078d4, #005a9e); color: #fff; padding: 1.25rem 2rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,.15); }
    header svg { width: 28px; height: 28px; fill: #fff; flex-shrink: 0; }
    header h1 { font-size: 1.25rem; font-weight: 600; }
    .header-spacer { flex: 1; }
    .user-info { display: flex; align-items: center; gap: 0.6rem; font-size: 0.85rem; }
    .user-info span { opacity: 0.9; }
    .btn-logout { background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.3); padding: 0.3rem 0.8rem; border-radius: 6px; font-size: 0.78rem; cursor: pointer; text-decoration: none; transition: background .15s; }
    .btn-logout:hover { background: rgba(255,255,255,0.25); }

    main { max-width: 820px; margin: 2rem auto; padding: 0 1rem; }

    .card { background: #fff; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 4px rgba(0,0,0,.08); margin-bottom: 1.5rem; }
    .card h2 { font-size: 1.05rem; margin-bottom: 1rem; color: #0078d4; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; }
    .form-grid .full { grid-column: 1 / -1; }

    label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.25rem; color: #444; }
    input, select, textarea {
      width: 100%; padding: 0.55rem 0.7rem; border: 1.5px solid #cdd5de; border-radius: 8px;
      font-size: 0.9rem; font-family: inherit; transition: border-color .15s;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #0078d4; box-shadow: 0 0 0 3px rgba(0,120,212,.12); }
    textarea { resize: vertical; min-height: 56px; }

    .btn { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.6rem 1.3rem; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background .15s, transform .1s; }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: #0078d4; color: #fff; }
    .btn-primary:hover { background: #005a9e; }
    .btn-danger { background: #d32f2f; color: #fff; font-size: .78rem; padding: .35rem .7rem; border-radius: 6px; }
    .btn-danger:hover { background: #b71c1c; }
    .btn-danger-outline { background: transparent; color: #d32f2f; border: 1.5px solid #d32f2f; font-size: .78rem; padding: .3rem .7rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all .15s; }
    .btn-danger-outline:hover { background: #d32f2f; color: #fff; }
    .btn-secondary { background: #e0e0e0; color: #333; font-size: .78rem; padding: .35rem .7rem; border-radius: 6px; }
    .btn-secondary:hover { background: #ccc; }
    .btn-sm-cancel { background: transparent; color: #666; border: 1.5px solid #ccc; font-size: .72rem; padding: .25rem .55rem; border-radius: 5px; cursor: pointer; font-weight: 600; }
    .btn-sm-cancel:hover { background: #f5f5f5; }
    .form-actions { margin-top: 1rem; display: flex; gap: .6rem; }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; padding: 0.6rem 0.75rem; background: #f5f7fa; color: #555; font-weight: 600; border-bottom: 2px solid #e0e4ea; white-space: nowrap; }
    td { padding: 0.55rem 0.75rem; border-bottom: 1px solid #eee; }
    tr:hover td { background: #f5faff; }

    .badge { display: inline-block; padding: 0.15rem 0.55rem; border-radius: 999px; font-size: 0.72rem; font-weight: 600; }
    .badge-billable { background: #e8f5e9; color: #2e7d32; }
    .badge-non { background: #fff3e0; color: #e65100; }

    .empty-state { text-align: center; padding: 2.5rem 1rem; color: #999; }
    .empty-state svg { width: 48px; height: 48px; fill: #ccc; margin-bottom: .5rem; }

    .summary-row { display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .summary-item { font-size: .9rem; }
    .summary-item strong { color: #0078d4; }

    .confirm-inline { display: inline-flex; align-items: center; gap: .35rem; }

    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: #323232; color: #fff; padding: .65rem 1.2rem; border-radius: 8px; font-size: .85rem; opacity: 0; transform: translateY(10px); transition: all .25s; pointer-events: none; z-index: 100; }
    .toast.show { opacity: 1; transform: translateY(0); }

    @media (max-width: 560px) { .form-grid { grid-template-columns: 1fr; } }

    .demo-banner { background: #fff3cd; color: #664d03; padding: 0.5rem 1rem; text-align: center; font-size: 0.8rem; border-bottom: 1px solid #ffecb5; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    .demo-banner svg { width: 16px; height: 16px; fill: #664d03; flex-shrink: 0; }
    .demo-banner a { color: #664d03; }
  </style>
</head>
<body>

<div class="demo-banner">
  <svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
  <span><strong>Demo Environment</strong> &mdash; This application is for demonstration and evaluation purposes only. Data may be reset at any time.</span>
</div>

<header>
  <svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/></svg>
  <h1>Time Entry</h1>
  <div class="header-spacer"></div>
  <div class="user-info" id="userInfo"></div>
</header>

<main>
  <div class="card">
    <h2 id="formTitle">&#10133; New Time Entry</h2>
    <form id="entryForm">
      <input type="hidden" id="editId" value="">
      <div class="form-grid">
        <div>
          <label for="entryDate">Date</label>
          <input type="date" id="entryDate" required>
        </div>
        <div>
          <label for="project">Project</label>
          <select id="project" required>
            <option value="">Select project&hellip;</option>
            <option>Contoso Web Redesign</option>
            <option>Fabrikam API Migration</option>
            <option>Internal &ndash; Admin</option>
            <option>Northwind Mobile App</option>
            <option>Adventure Works Analytics</option>
          </select>
        </div>
        <div>
          <label for="task">Task</label>
          <select id="task" required>
            <option value="">Select task&hellip;</option>
            <option>Development</option>
            <option>Design</option>
            <option>Testing / QA</option>
            <option>Code Review</option>
            <option>Meeting</option>
            <option>Documentation</option>
            <option>DevOps / Deployment</option>
          </select>
        </div>
        <div>
          <label for="hours">Hours</label>
          <input type="number" id="hours" min="0.25" max="24" step="0.25" placeholder="e.g. 2.5" required>
        </div>
        <div>
          <label for="billable">Billable</label>
          <select id="billable">
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="full">
          <label for="notes">Notes <span style="font-weight:400;color:#999">(optional)</span></label>
          <textarea id="notes" rows="2" placeholder="Brief description of work performed&hellip;"></textarea>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary" id="submitBtn">
          <svg style="width:16px;height:16px;fill:#fff" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"/></svg>
          Save Entry
        </button>
        <button type="button" class="btn btn-secondary" id="cancelBtn" style="display:none" onclick="cancelEdit()">Cancel</button>
      </div>
    </form>
  </div>

  <div class="card" id="summaryCard" style="display:none">
    <h2>&#128202; Summary</h2>
    <div class="summary-row" id="summary"></div>
  </div>

  <div class="card">
    <h2>&#128203; Time Entries</h2>
    <div class="table-wrap" id="tableWrap"></div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
  const API = '/api/entries';
  let entries = [];
  let pendingDeleteId = null;

  document.getElementById('entryDate').valueAsDate = new Date();

  // --- Auth: show logged-in user ---
  (async function loadUser() {
    try {
      const res = await fetch('/.auth/me');
      if (!res.ok) return;
      const data = await res.json();
      const user = data.clientPrincipal;
      if (user) {
        document.getElementById('userInfo').innerHTML =
          '<span>' + esc(user.userDetails) + '</span>' +
          '<a class="btn-logout" href="/.auth/logout">Sign out</a>';
      }
    } catch (e) { /* ignore */ }
  })();

  // --- Load entries ---
  async function loadEntries() {
    try {
      const res = await fetch(API);
      if (!res.ok) throw new Error('Failed to load');
      entries = await res.json();
    } catch (err) {
      console.error('Load error:', err);
      toast('\u26a0 Could not load entries');
      entries = [];
    }
    render();
  }

  // --- Save / Update ---
  document.getElementById('entryForm').addEventListener('submit', async e => {
    e.preventDefault();
    const editId = document.getElementById('editId').value;
    const entry = {
      id: editId || undefined,
      date: document.getElementById('entryDate').value,
      project: document.getElementById('project').value,
      task: document.getElementById('task').value,
      hours: parseFloat(document.getElementById('hours').value),
      billable: document.getElementById('billable').value === 'yes',
      notes: document.getElementById('notes').value.trim()
    };
    try {
      const res = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      });
      if (!res.ok) throw new Error('Save failed');
      toast(editId ? 'Entry updated \u2713' : 'Entry saved \u2713');
    } catch (err) {
      toast('\u26a0 Save failed');
      console.error(err);
      return;
    }
    e.target.reset();
    document.getElementById('entryDate').valueAsDate = new Date();
    cancelEdit();
    await loadEntries();
  });

  // --- Render table ---
  function render() {
    const wrap = document.getElementById('tableWrap');
    if (!entries.length) {
      wrap.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67V7z"/></svg><p>No time entries yet.<br>Add your first entry above.</p></div>';
      document.getElementById('summaryCard').style.display = 'none';
      return;
    }
    let html = '<table><thead><tr><th>Date</th><th>Project</th><th>Task</th><th>Hours</th><th>Billable</th><th>Notes</th><th></th></tr></thead><tbody>';
    entries.forEach(e => {
      const hrs = Number(e.hours) || 0;
      const isBillable = e.billable === true || e.billable === 'true';
      const isConfirming = (pendingDeleteId === e.id);
      html += '<tr>' +
        '<td>' + formatDate(e.date || '') + '</td>' +
        '<td>' + esc(e.project || '') + '</td>' +
        '<td>' + esc(e.task || '') + '</td>' +
        '<td><strong>' + hrs.toFixed(2) + '</strong></td>' +
        '<td><span class="badge ' + (isBillable ? 'badge-billable' : 'badge-non') + '">' + (isBillable ? 'Billable' : 'Non-bill.') + '</span></td>' +
        '<td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + esc(e.notes || '') + '">' + (esc(e.notes) || '\u2014') + '</td>' +
        '<td style="white-space:nowrap">' +
          '<button class="btn btn-secondary" onclick="editEntry(\'' + e.id + '\')">Edit</button> ' +
          (isConfirming
            ? '<span class="confirm-inline">' +
                '<button class="btn btn-danger" onclick="confirmDelete(\'' + e.id + '\')">Confirm</button>' +
                '<button class="btn-sm-cancel" onclick="cancelDelete()">Cancel</button>' +
              '</span>'
            : '<button class="btn-danger-outline" onclick="startDelete(\'' + e.id + '\')">Delete</button>') +
        '</td>' +
      '</tr>';
    });
    html += '</tbody></table>';
    wrap.innerHTML = html;

    // Summary
    const total = entries.reduce((s, e) => s + (Number(e.hours) || 0), 0);
    const billable = entries.reduce((s, e) => s + ((e.billable === true || e.billable === 'true') ? (Number(e.hours) || 0) : 0), 0);
    const projects = new Set(entries.map(e => e.project)).size;
    document.getElementById('summary').innerHTML =
      '<div class="summary-item">Total: <strong>' + total.toFixed(2) + ' hrs</strong></div>' +
      '<div class="summary-item">Billable: <strong>' + billable.toFixed(2) + ' hrs</strong></div>' +
      '<div class="summary-item">Non-billable: <strong>' + (total - billable).toFixed(2) + ' hrs</strong></div>' +
      '<div class="summary-item">Entries: <strong>' + entries.length + '</strong></div>' +
      '<div class="summary-item">Projects: <strong>' + projects + '</strong></div>';
    document.getElementById('summaryCard').style.display = '';
  }

  // --- Edit ---
  function editEntry(id) {
    const e = entries.find(x => x.id === id);
    if (!e) return;
    document.getElementById('editId').value = e.id;
    document.getElementById('entryDate').value = e.date;
    document.getElementById('project').value = e.project;
    document.getElementById('task').value = e.task;
    document.getElementById('hours').value = e.hours;
    document.getElementById('billable').value = e.billable ? 'yes' : 'no';
    document.getElementById('notes').value = e.notes || '';
    document.getElementById('formTitle').textContent = '\u270f\ufe0f Edit Time Entry';
    document.getElementById('submitBtn').textContent = 'Update Entry';
    document.getElementById('cancelBtn').style.display = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function cancelEdit() {
    document.getElementById('editId').value = '';
    document.getElementById('formTitle').textContent = '\u2795 New Time Entry';
    document.getElementById('submitBtn').innerHTML = '<svg style="width:16px;height:16px;fill:#fff" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6z"/></svg> Save Entry';
    document.getElementById('cancelBtn').style.display = 'none';
  }

  // --- Delete (two-step inline confirmation) ---
  function startDelete(id) {
    pendingDeleteId = id;
    render();
  }

  function cancelDelete() {
    pendingDeleteId = null;
    render();
  }

  async function confirmDelete(id) {
    pendingDeleteId = null;
    try {
      const res = await fetch(API + '/' + id, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed');
      toast('Entry deleted');
    } catch (err) {
      toast('\u26a0 Delete failed');
      console.error(err);
      return;
    }
    await loadEntries();
  }

  // --- Helpers ---
  function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }
  function formatDate(d) { if (!d || !d.includes('-')) return d || ''; const [y, m, day] = d.split('-'); return m + '/' + day + '/' + y; }
  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 2000);
  }

  // Load on startup
  loadEntries();
</script>
</body>
</html>

